@using SFT.Blazor.Core.Dialogs
@using SFT.Core.Commands
@inject IFactoryTrackerCommands Commands
@inject IDialogService DialogService
@inject ISnackbar Snackbar

@if (Level is not null)
{
    <MudText Typo="Typo.h5" Class="mb-2">@Level.Identifier</MudText>
    @if (!string.IsNullOrWhiteSpace(Level.Description))
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">@Level.Description</MudText>
    }
    
    <!-- Inputs -->
    <div class="d-flex align-center mb-2">
        <MudText Typo="Typo.h6" Class="flex-grow-1">Inputs</MudText>
        <MudButton StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" Variant="Variant.Outlined" OnClick="OpenAddInputDialog" data-test-id="add-input-btn">Add Input</MudButton>
    </div>
    @if (!Level.Inputs.Any())
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary">No inputs configured.</MudText>
    }
    else
    {
        <MudTable Items="Level.Inputs.OrderBy(i => i.Resource?.Name)" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Resource</MudTh>
                <MudTh>Amount / min</MudTh>
                <MudTh>Source</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Resource?.Name</MudTd>
                <MudTd>@context.AmountPerMinute</MudTd>
                <MudTd>
                    @if (context.SourceMineId is not null)
                    {
                        <MudText Typo="Typo.body2">
                            <MudIcon Icon="@Icons.Material.Filled.Terrain" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            @context.SourceMine?.Name
                        </MudText>
                    }
                    else if (context.SourceFactoryLevelId is not null)
                    {
                        <MudText Typo="Typo.body2">
                            <MudIcon Icon="@Icons.Material.Filled.Factory" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            @SourceLevelLabel(context.SourceFactoryLevel)
                        </MudText>
                    }
                </MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" aria-label="Edit input" OnClick="() => OpenEditInputDialog(context)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" aria-label="Delete input" OnClick="() => DeleteInput(context)" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }

    <!-- Outputs -->
    <div class="d-flex align-center mb-2 mt-4">
        <MudText Typo="Typo.h6" Class="flex-grow-1">Outputs</MudText>
        <MudButton StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" Variant="Variant.Outlined" OnClick="OpenAddOutputDialog" data-test-id="add-output-btn">Add Output</MudButton>
    </div>
    @if (!Level.Outputs.Any())
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">No outputs configured.</MudText>
    }
    else
    {
        <MudTable Items="Level.Outputs.OrderBy(o => o.Resource?.Name)" Dense="true" Hover="true" Class="mb-4">
            <HeaderContent>
                <MudTh>Resource</MudTh>
                <MudTh>Total / min</MudTh>
                <MudTh>Used / min</MudTh>
                <MudTh>Free / min</MudTh>
                <MudTh>Consumers</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                @{
                    var used = GetOutputUsed(context.ResourceId);
                    var free = context.AmountPerMinute - used;
                    var pctUsed = context.AmountPerMinute > 0 ? Math.Min(1.0, (double)used / (double)context.AmountPerMinute) : 0.0;
                    var capacityColor = GetCapacityColor(pctUsed);
                    var consumers = GetOutputConsumers(context.ResourceId).ToList();
                }
                <MudTd>@context.Resource?.Name</MudTd>
                <MudTd>@context.AmountPerMinute.ToString("0.##")</MudTd>
                <MudTd>@used.ToString("0.##")</MudTd>
                <MudTd>
                    <span style="color:@capacityColor; font-weight:600;">@free.ToString("0.##")</span>
                    <MudProgressLinear Value="@(pctUsed * 100)" Color="@GetProgressColor(pctUsed)" Rounded="true" Size="Size.Small" Class="mt-1" Style="max-width:80px;" />
                </MudTd>
                <MudTd>
                    @if (!consumers.Any())
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">None</MudText>
                    }
                    else
                    {
                        @foreach (var (consumerLevel, input) in consumers)
                        {
                            <div style="font-size:0.8rem;">
                                <MudIcon Icon="@Icons.Material.Filled.Factory" Size="Size.Small" Style="vertical-align:middle;" Class="mr-1" />
                                @($"{consumerLevel.Factory?.Name} / {consumerLevel.Identifier}") &mdash; @input.AmountPerMinute.ToString("0.##")/min
                            </div>
                        }
                    }
                </MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" aria-label="Edit output" OnClick="() => OpenEditOutputDialog(context)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" aria-label="Delete output" OnClick="() => DeleteOutput(context)" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }

}

@code {
    [Parameter] public FactoryLevel? Level { get; set; }
    [Parameter] public IReadOnlyList<Resource> AllResources { get; set; } = [];
    [Parameter] public IReadOnlyList<Mine> AllMines { get; set; } = [];
    [Parameter] public IReadOnlyList<FactoryLevel> AllLevels { get; set; } = [];
    [Parameter] public EventCallback OnChanged { get; set; }

    private static string SourceLevelLabel(FactoryLevel? level) =>
        level is null ? "?" : $"{level.Factory?.Name} / {level.Identifier}";

    private IReadOnlyList<FactoryLevel> OtherLevels =>
        Level is null ? AllLevels : AllLevels.Where(l => l.Id != Level.Id).ToList();

    private decimal GetOutputUsed(int resourceId) =>
        AllLevels
            .SelectMany(l => l.Inputs)
            .Where(i => i.SourceFactoryLevelId == Level!.Id && i.ResourceId == resourceId)
            .Sum(i => i.AmountPerMinute);

    private IEnumerable<(FactoryLevel Level, FactoryInput Input)> GetOutputConsumers(int resourceId) =>
        AllLevels
            .SelectMany(l => l.Inputs.Select(i => (Level: l, Input: i)))
            .Where(x => x.Input.SourceFactoryLevelId == Level!.Id && x.Input.ResourceId == resourceId);

    private static string GetCapacityColor(double pct) => pct switch
    {
        >= 1.0 => "var(--mud-palette-error)",
        >= 0.75 => "var(--mud-palette-warning)",
        _ => "var(--mud-palette-success)"
    };

    private static Color GetProgressColor(double pct) => pct switch
    {
        >= 1.0 => Color.Error,
        >= 0.75 => Color.Warning,
        _ => Color.Success
    };

    // Output dialogs
    private async Task OpenAddOutputDialog()
    {
        var parameters = new DialogParameters<FactoryOutputDialog>
        {
            { x => x.FactoryLevelId, Level!.Id },
            { x => x.Resources, AllResources }
        };
        var dialog = await DialogService.ShowAsync<FactoryOutputDialog>("Add Output", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is FactoryOutput output)
        {
            try
            {
                await Commands.AddFactoryOutputAsync(output);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Output added.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding output: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditOutputDialog(FactoryOutput output)
    {
        var parameters = new DialogParameters<FactoryOutputDialog>
        {
            { x => x.Output, output },
            { x => x.Resources, AllResources }
        };
        var dialog = await DialogService.ShowAsync<FactoryOutputDialog>("Edit Output", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is FactoryOutput updated)
        {
            try
            {
                await Commands.UpdateFactoryOutputAsync(updated);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Output updated.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating output: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteOutput(FactoryOutput output)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.Message, $"Are you sure you want to delete the output \"{output.Resource?.Name}\"?" }
        };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Output", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            try
            {
                await Commands.DeleteFactoryOutputAsync(output.Id);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Output deleted.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting output: {ex.Message}", Severity.Error);
            }
        }
    }

    // Input dialogs
    private async Task OpenAddInputDialog()
    {
        var parameters = new DialogParameters<FactoryInputDialog>
        {
            { x => x.FactoryLevelId, Level!.Id },
            { x => x.Resources, AllResources },
            { x => x.Mines, AllMines },
            { x => x.AllLevels, OtherLevels }
        };
        var dialog = await DialogService.ShowAsync<FactoryInputDialog>("Add Input", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is FactoryInput input)
        {
            try
            {
                await Commands.AddFactoryInputAsync(input);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Input added.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding input: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditInputDialog(FactoryInput input)
    {
        var parameters = new DialogParameters<FactoryInputDialog>
        {
            { x => x.Input, input },
            { x => x.Resources, AllResources },
            { x => x.Mines, AllMines },
            { x => x.AllLevels, OtherLevels }
        };
        var dialog = await DialogService.ShowAsync<FactoryInputDialog>("Edit Input", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is FactoryInput updated)
        {
            try
            {
                await Commands.UpdateFactoryInputAsync(updated);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Input updated.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating input: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteInput(FactoryInput input)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.Message, $"Are you sure you want to delete the input \"{input.Resource?.Name}\"?" }
        };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Input", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            try
            {
                await Commands.DeleteFactoryInputAsync(input.Id);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Input deleted.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting input: {ex.Message}", Severity.Error);
            }
        }
    }
}
