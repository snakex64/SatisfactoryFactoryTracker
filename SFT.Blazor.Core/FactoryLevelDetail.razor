@using SFT.Blazor.Core.Dialogs
@using SFT.Core.Commands
@inject IFactoryTrackerCommands Commands
@inject IDialogService DialogService
@inject ISnackbar Snackbar

@if (Level is not null)
{
    <MudText Typo="Typo.h5" Class="mb-2">@Level.Identifier</MudText>
    @if (!string.IsNullOrWhiteSpace(Level.Description))
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">@Level.Description</MudText>
    }

    <!-- Outputs -->
    <div class="d-flex align-center mb-2 mt-4">
        <MudText Typo="Typo.h6" Class="flex-grow-1">Outputs</MudText>
        <MudButton StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" Variant="Variant.Outlined" OnClick="OpenAddOutputDialog" data-test-id="add-output-btn">Add Output</MudButton>
    </div>
    @if (!Level.Outputs.Any())
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">No outputs configured.</MudText>
    }
    else
    {
        <MudTable Items="Level.Outputs.OrderBy(o => o.Resource?.Name)" Dense="true" Hover="true" Class="mb-4">
            <HeaderContent>
                <MudTh>Resource</MudTh>
                <MudTh>Amount / min</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Resource?.Name</MudTd>
                <MudTd>@context.AmountPerMinute</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" aria-label="Edit output" OnClick="() => OpenEditOutputDialog(context)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" aria-label="Delete output" OnClick="() => DeleteOutput(context)" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }

    <!-- Inputs -->
    <div class="d-flex align-center mb-2">
        <MudText Typo="Typo.h6" Class="flex-grow-1">Inputs</MudText>
        <MudButton StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" Variant="Variant.Outlined" OnClick="OpenAddInputDialog" data-test-id="add-input-btn">Add Input</MudButton>
    </div>
    @if (!Level.Inputs.Any())
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary">No inputs configured.</MudText>
    }
    else
    {
        <MudTable Items="Level.Inputs.OrderBy(i => i.Resource?.Name)" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Resource</MudTh>
                <MudTh>Amount / min</MudTh>
                <MudTh>Source</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Resource?.Name</MudTd>
                <MudTd>@context.AmountPerMinute</MudTd>
                <MudTd>
                    @if (context.SourceMineId is not null)
                    {
                        <MudText Typo="Typo.body2">
                            <MudIcon Icon="@Icons.Material.Filled.Terrain" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            @context.SourceMine?.Name
                        </MudText>
                    }
                    else if (context.SourceFactoryLevelId is not null)
                    {
                        <MudText Typo="Typo.body2">
                            <MudIcon Icon="@Icons.Material.Filled.Factory" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            @SourceLevelLabel(context.SourceFactoryLevel)
                        </MudText>
                    }
                </MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" aria-label="Edit input" OnClick="() => OpenEditInputDialog(context)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" aria-label="Delete input" OnClick="() => DeleteInput(context)" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
}

@code {
    [Parameter] public FactoryLevel? Level { get; set; }
    [Parameter] public IReadOnlyList<Resource> AllResources { get; set; } = [];
    [Parameter] public IReadOnlyList<Mine> AllMines { get; set; } = [];
    [Parameter] public IReadOnlyList<FactoryLevel> AllLevels { get; set; } = [];
    [Parameter] public EventCallback OnChanged { get; set; }

    private static string SourceLevelLabel(FactoryLevel? level) =>
        level is null ? "?" : $"{level.Factory?.Name} / {level.Identifier}";

    private IReadOnlyList<FactoryLevel> OtherLevels =>
        Level is null ? AllLevels : AllLevels.Where(l => l.Id != Level.Id).ToList();

    // Output dialogs
    private async Task OpenAddOutputDialog()
    {
        var parameters = new DialogParameters<FactoryOutputDialog>
        {
            { x => x.FactoryLevelId, Level!.Id },
            { x => x.Resources, AllResources }
        };
        var dialog = await DialogService.ShowAsync<FactoryOutputDialog>("Add Output", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is FactoryOutput output)
        {
            try
            {
                await Commands.AddFactoryOutputAsync(output);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Output added.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding output: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditOutputDialog(FactoryOutput output)
    {
        var parameters = new DialogParameters<FactoryOutputDialog>
        {
            { x => x.Output, output },
            { x => x.Resources, AllResources }
        };
        var dialog = await DialogService.ShowAsync<FactoryOutputDialog>("Edit Output", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is FactoryOutput updated)
        {
            try
            {
                await Commands.UpdateFactoryOutputAsync(updated);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Output updated.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating output: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteOutput(FactoryOutput output)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.Message, $"Are you sure you want to delete the output \"{output.Resource?.Name}\"?" }
        };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Output", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            try
            {
                await Commands.DeleteFactoryOutputAsync(output.Id);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Output deleted.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting output: {ex.Message}", Severity.Error);
            }
        }
    }

    // Input dialogs
    private async Task OpenAddInputDialog()
    {
        var parameters = new DialogParameters<FactoryInputDialog>
        {
            { x => x.FactoryLevelId, Level!.Id },
            { x => x.Resources, AllResources },
            { x => x.Mines, AllMines },
            { x => x.AllLevels, OtherLevels }
        };
        var dialog = await DialogService.ShowAsync<FactoryInputDialog>("Add Input", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is FactoryInput input)
        {
            try
            {
                await Commands.AddFactoryInputAsync(input);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Input added.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding input: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditInputDialog(FactoryInput input)
    {
        var parameters = new DialogParameters<FactoryInputDialog>
        {
            { x => x.Input, input },
            { x => x.Resources, AllResources },
            { x => x.Mines, AllMines },
            { x => x.AllLevels, OtherLevels }
        };
        var dialog = await DialogService.ShowAsync<FactoryInputDialog>("Edit Input", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is FactoryInput updated)
        {
            try
            {
                await Commands.UpdateFactoryInputAsync(updated);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Input updated.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating input: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteInput(FactoryInput input)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.Message, $"Are you sure you want to delete the input \"{input.Resource?.Name}\"?" }
        };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Input", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            try
            {
                await Commands.DeleteFactoryInputAsync(input.Id);
                await OnChanged.InvokeAsync();
                Snackbar.Add("Input deleted.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting input: {ex.Message}", Severity.Error);
            }
        }
    }
}
