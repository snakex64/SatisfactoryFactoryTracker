@using SFT.Blazor.Core.Dialogs
@using SFT.Core.Commands
@using SFT.Core.Queries
@inject IFactoryTrackerQueries Queries
@inject IFactoryTrackerCommands Commands
@inject IDialogService DialogService
@inject ISnackbar Snackbar

@* Marker element present only after the first interactive (client-side) render.
   OnAfterRender is not called during static SSR, so this element signals to
   Playwright tests that the Blazor circuit is connected and events are wired. *@
@if (_isInteractive)
{
    <span id="blazor-interactive" aria-hidden="true" style="display:none"></span>
}

<MudGrid Spacing="0" Style="height: calc(100vh - 80px);">
    <!-- Left tree panel -->
    <MudItem xs="3" Style="border-right: 1px solid var(--mud-palette-divider); overflow-y: auto; height: 100%;">
        <MudPaper Elevation="0" Class="pa-2">

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-2">@errorMessage</MudAlert>
            }

            <!-- Raw Ore Mines -->
            <div class="d-flex align-center px-1 py-1 mb-1">
                <MudIcon Icon="@Icons.Material.Filled.Terrain" Size="Size.Small" Class="mr-1" Color="Color.Primary" />
                <MudText Typo="Typo.subtitle2" Class="flex-grow-1" Style="font-weight:700;">Raw Ore Mines</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" aria-label="Add mine" OnClick="OpenAddMineDialog" data-test-id="add-mine-btn" />
            </div>
            @if (!mines.Any())
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="px-4 mb-2 d-block">No mines added yet.</MudText>
            }
            else
            {
                <MudTreeView T="Mine" Dense="true" Hover="true">
                    @foreach (var mine in mines)
                    {
                        var used = GetMineUsedPerMinute(mine.Id);
                        var free = mine.OutputPerMinute - used;
                        var pctUsed = mine.OutputPerMinute > 0 ? Math.Min(1.0, (double)used / (double)mine.OutputPerMinute) : 0.0;
                        <MudTreeViewItem T="Mine" Value="@mine" CanExpand="false"
                                         Selected="@(selectedMine?.Id == mine.Id)"
                                         OnClick="@(() => SelectMine(mine))">
                            <BodyContent>
                                <div class="d-flex align-center flex-grow-1" style="min-width:0">
                                    <div class="flex-grow-1" style="min-width:0">
                                        <MudText Typo="Typo.body2">@mine.Name</MudText>
                                        <div style="font-size:0.72rem; color:var(--mud-palette-text-secondary);">
                                            @mine.Resource?.Name &mdash;
                                            <span style="color:@GetCapacityColor(pctUsed); font-weight:600;">@free.ToString("0.##") / @mine.OutputPerMinute.ToString("0.##") free</span>
                                        </div>
                                    </div>
                                    <span @onclick:stopPropagation="true">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                                       aria-label="Edit mine"
                                                       OnClick="@(() => OpenEditMineDialog(mine))" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                                       aria-label="Delete mine"
                                                       OnClick="@(() => DeleteMine(mine))" />
                                    </span>
                                </div>
                            </BodyContent>
                        </MudTreeViewItem>
                    }
                </MudTreeView>
            }

            <MudDivider Class="my-3" />

            <!-- Factories -->
            <div class="d-flex align-center px-1 py-1 mb-1">
                <MudIcon Icon="@Icons.Material.Filled.Factory" Size="Size.Small" Class="mr-1" Color="Color.Primary" />
                <MudText Typo="Typo.subtitle2" Class="flex-grow-1" Style="font-weight:700;">Factories</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" aria-label="Add factory" OnClick="OpenAddFactoryDialog" data-test-id="add-factory-btn" />
            </div>
            @if (!factories.Any())
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="px-4 d-block">No factories added yet.</MudText>
            }
            else
            {
                <MudTreeView T="object" Dense="true" Hover="true">
                    @foreach (var factory in factories)
                    {
                        <MudTreeViewItem T="object" Value="@((object)factory)"
                                         Expanded="@_expandedFactoryIds.Contains(factory.Id)"
                                         ExpandedChanged="@(v => ToggleFactoryExpanded(factory.Id, v))">
                            <BodyContent>
                                <div class="d-flex align-center flex-grow-1" style="min-width:0">
                                    <div class="flex-grow-1" style="min-width:0">
                                        <MudText Typo="Typo.body2" Style="font-weight:600;">@factory.Name</MudText>
                                        @if (!string.IsNullOrWhiteSpace(factory.Description))
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@factory.Description</MudText>
                                        }
                                    </div>
                                    <span @onclick:stopPropagation="true">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                                       aria-label="Edit factory"
                                                       OnClick="@(() => OpenEditFactoryDialog(factory))" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                                       aria-label="Delete factory"
                                                       OnClick="@(() => DeleteFactory(factory))" />
                                    </span>
                                </div>
                            </BodyContent>
                            <ChildContent>
                                @foreach (var level in factory.Levels.OrderBy(l => l.Identifier))
                                {
                                    <MudTreeViewItem T="object" Value="@((object)level)" CanExpand="false"
                                                     Selected="@(selectedLevel?.Id == level.Id)"
                                                     OnClick="@(() => SelectLevel(level))">
                                        <BodyContent>
                                            <div class="d-flex align-center flex-grow-1" style="min-width:0">
                                                <div class="flex-grow-1" style="min-width:0">
                                                    <MudText Typo="Typo.body2">@level.Identifier</MudText>
                                                    @if (!string.IsNullOrWhiteSpace(level.Description))
                                                    {
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@level.Description</MudText>
                                                    }
                                                </div>
                                                <span @onclick:stopPropagation="true">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                                                   aria-label="Edit level"
                                                                   OnClick="@(() => OpenEditLevelDialog(level))" />
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                                                   aria-label="Delete level"
                                                                   OnClick="@(() => DeleteLevel(level))" />
                                                </span>
                                            </div>
                                        </BodyContent>
                                    </MudTreeViewItem>
                                }
                                <MudTreeViewItem T="object" Value="@((object)("add-level-" + factory.Id))" CanExpand="false"
                                                 Icon="@Icons.Material.Filled.Add" IconColor="Color.Primary"
                                                 Text="Add level"
                                                 OnClick="@(() => OpenAddLevelDialog(factory))" />
                            </ChildContent>
                        </MudTreeViewItem>
                    }
                </MudTreeView>
            }
        </MudPaper>
    </MudItem>

    <!-- Right detail panel -->
    <MudItem xs="9" Style="overflow-y: auto; height: 100%;">
        <MudPaper Elevation="0" Class="pa-4">
            @if (selectedMine is not null)
            {
                <MineDetail Mine="selectedMine" UsedPerMinute="@GetMineUsedPerMinute(selectedMine.Id)" OnChanged="OnMineChangedAsync" />
            }
            else if (selectedLevel is null)
            {
                <MudText Typo="Typo.body1" Color="Color.Secondary">Select a mine or factory level to view its details.</MudText>
            }
            else
            {
                <FactoryLevelDetail Level="selectedLevel"
                                    AllResources="allResources"
                                    AllMines="mines"
                                    AllLevels="factories.SelectMany(f => f.Levels).ToList()"
                                    OnChanged="OnLevelChangedAsync" />
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private IReadOnlyList<Mine> mines = [];
    private IReadOnlyList<Factory> factories = [];
    private IReadOnlyList<Resource> resources = [];
    private IReadOnlyList<Resource> allResources = [];
    private FactoryLevel? selectedLevel;
    private Mine? selectedMine;
    private string? errorMessage;
    private bool _isInteractive;
    private HashSet<int> _expandedFactoryIds = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    // OnAfterRender is only called during interactive rendering, never during static SSR.
    // Setting _isInteractive here lets Playwright wait until the Blazor circuit is connected.
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _isInteractive = true;
            StateHasChanged();
        }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            mines = await Queries.GetMinesAsync();
            factories = await Queries.GetFactoriesAsync();
            resources = await Queries.GetRawResourcesAsync();
            allResources = await Queries.GetResourcesAsync();
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Unable to load data: {ex.Message}";
        }
    }

    private void SelectLevel(FactoryLevel level)
    {
        selectedLevel = level;
        selectedMine = null;
        _expandedFactoryIds.Add(level.FactoryId);
    }

    private void SelectMine(Mine mine)
    {
        selectedMine = mine;
        selectedLevel = null;
    }

    private async Task OnLevelChangedAsync()
    {
        var previousLevelId = selectedLevel?.Id;
        await LoadDataAsync();
        if (previousLevelId is not null)
            selectedLevel = factories.SelectMany(f => f.Levels).FirstOrDefault(l => l.Id == previousLevelId);
    }

    private async Task OnMineChangedAsync()
    {
        var previousMineId = selectedMine?.Id;
        await LoadDataAsync();
        if (previousMineId is not null)
            selectedMine = mines.FirstOrDefault(m => m.Id == previousMineId);
    }

    // Mine dialogs
    private async Task OpenAddMineDialog()
    {
        var parameters = new DialogParameters<MineDialog>
        {
            { x => x.Resources, resources }
        };
        var dialog = await DialogService.ShowAsync<MineDialog>("Add Mine", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is Mine mine)
        {
            try
            {
                await Commands.AddMineAsync(mine);
                await LoadDataAsync();
                Snackbar.Add("Mine added.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding mine: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditMineDialog(Mine mine)
    {
        var parameters = new DialogParameters<MineDialog>
        {
            { x => x.Mine, mine },
            { x => x.Resources, resources }
        };
        var dialog = await DialogService.ShowAsync<MineDialog>("Edit Mine", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is Mine updated)
        {
            try
            {
                await Commands.UpdateMineAsync(updated);
                await LoadDataAsync();
                Snackbar.Add("Mine updated.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating mine: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteMine(Mine mine)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.Message, $"Are you sure you want to delete mine \"{mine.Name}\"?" }
        };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Mine", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            try
            {
                if (selectedMine?.Id == mine.Id)
                    selectedMine = null;
                await Commands.DeleteMineAsync(mine.Id);
                await LoadDataAsync();
                Snackbar.Add("Mine deleted.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting mine: {ex.Message}", Severity.Error);
            }
        }
    }

    // Factory dialogs
    private async Task OpenAddFactoryDialog()
    {
        var dialog = await DialogService.ShowAsync<FactoryDialog>("Add Factory");
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is Factory factory)
        {
            try
            {
                await Commands.AddFactoryAsync(factory);
                await LoadDataAsync();
                Snackbar.Add("Factory added.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding factory: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditFactoryDialog(Factory factory)
    {
        var parameters = new DialogParameters<FactoryDialog>
        {
            { x => x.Factory, factory }
        };
        var dialog = await DialogService.ShowAsync<FactoryDialog>("Edit Factory", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is Factory updated)
        {
            try
            {
                await Commands.UpdateFactoryAsync(updated);
                await LoadDataAsync();
                Snackbar.Add("Factory updated.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating factory: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteFactory(Factory factory)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.Message, $"Are you sure you want to delete factory \"{factory.Name}\" and all its levels?" }
        };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Factory", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            try
            {
                if (selectedLevel?.FactoryId == factory.Id)
                    selectedLevel = null;
                await Commands.DeleteFactoryAsync(factory.Id);
                await LoadDataAsync();
                Snackbar.Add("Factory deleted.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting factory: {ex.Message}", Severity.Error);
            }
        }
    }

    // Level dialogs
    private async Task OpenAddLevelDialog(Factory factory)
    {
        var parameters = new DialogParameters<FactoryLevelDialog>
        {
            { x => x.FactoryId, factory.Id }
        };
        var dialog = await DialogService.ShowAsync<FactoryLevelDialog>("Add Level", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is FactoryLevel level)
        {
            try
            {
                await Commands.AddFactoryLevelAsync(level);
                await LoadDataAsync();
                Snackbar.Add("Level added.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error adding level: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditLevelDialog(FactoryLevel level)
    {
        var parameters = new DialogParameters<FactoryLevelDialog>
        {
            { x => x.Level, level }
        };
        var dialog = await DialogService.ShowAsync<FactoryLevelDialog>("Edit Level", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled && result.Data is FactoryLevel updated)
        {
            try
            {
                await Commands.UpdateFactoryLevelAsync(updated);
                await LoadDataAsync();
                if (selectedLevel?.Id == updated.Id)
                    selectedLevel = factories.SelectMany(f => f.Levels).FirstOrDefault(l => l.Id == updated.Id);
                Snackbar.Add("Level updated.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating level: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteLevel(FactoryLevel level)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.Message, $"Are you sure you want to delete level \"{level.Identifier}\"?" }
        };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Level", parameters);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            try
            {
                if (selectedLevel?.Id == level.Id)
                    selectedLevel = null;
                await Commands.DeleteFactoryLevelAsync(level.Id);
                await LoadDataAsync();
                Snackbar.Add("Level deleted.", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting level: {ex.Message}", Severity.Error);
            }
        }
    }

    private decimal GetMineUsedPerMinute(int mineId) =>
        factories.SelectMany(f => f.Levels)
                 .SelectMany(l => l.Inputs)
                 .Where(i => i.SourceMineId == mineId)
                 .Sum(i => i.AmountPerMinute);

    private static string GetCapacityColor(double pct) => pct switch
    {
        >= 1.0 => "var(--mud-palette-error)",
        >= 0.75 => "var(--mud-palette-warning)",
        _ => "var(--mud-palette-success)"
    };

    private void ToggleFactoryExpanded(int factoryId, bool expanded)
    {
        if (expanded) _expandedFactoryIds.Add(factoryId);
        else _expandedFactoryIds.Remove(factoryId);
    }
}
